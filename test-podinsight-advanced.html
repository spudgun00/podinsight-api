<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PodInsight Advanced Testing Suite</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        /* Tab Navigation */
        .tab-nav {
            display: flex;
            background: #f8f9fa;
            border-bottom: 1px solid #e0e0e0;
        }
        .tab-button {
            flex: 1;
            padding: 16px 24px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            color: #666;
            transition: all 0.2s;
        }
        .tab-button.active {
            background: white;
            color: #333;
            border-bottom: 2px solid #007bff;
        }
        .tab-button:hover {
            background: #e9ecef;
            color: #333;
        }
        
        /* Tab Content */
        .tab-content {
            display: none;
            padding: 30px;
        }
        .tab-content.active {
            display: block;
        }
        
        /* Console/Log Section */
        .console-section {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: #1e1e1e;
            color: #d4d4d4;
            max-height: 300px;
            overflow-y: auto;
            border-top: 3px solid #007bff;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 12px;
            padding: 10px;
            z-index: 1000;
        }
        .console-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid #333;
        }
        .console-title {
            color: #fff;
            font-weight: bold;
        }
        .console-actions {
            display: flex;
            gap: 10px;
        }
        .console-btn {
            background: #333;
            color: #fff;
            border: none;
            padding: 4px 12px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 11px;
        }
        .console-btn:hover {
            background: #444;
        }
        .log-entry {
            margin: 4px 0;
            padding: 2px 0;
            border-bottom: 1px solid #2a2a2a;
        }
        .log-time {
            color: #888;
            margin-right: 10px;
        }
        .log-type {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 10px;
            margin-right: 10px;
            font-weight: bold;
        }
        .log-type.info { background: #0e639c; color: #fff; }
        .log-type.success { background: #0f7938; color: #fff; }
        .log-type.warning { background: #cc6600; color: #fff; }
        .log-type.error { background: #a31515; color: #fff; }
        .log-type.debug { background: #6a1b9a; color: #fff; }
        
        /* Main content adjustment for console */
        body.console-open {
            padding-bottom: 320px;
        }
        
        h1 {
            color: #333;
            margin-bottom: 10px;
        }
        .subtitle {
            color: #666;
            margin-bottom: 30px;
        }
        
        /* Search Section Styles */
        .search-section {
            margin-bottom: 40px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        .search-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        input, select {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
        }
        input[type="text"] {
            flex: 1;
            min-width: 200px;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            transition: background 0.2s;
        }
        button:hover {
            background: #0056b3;
        }
        button:active {
            transform: translateY(1px);
        }
        
        /* Quick Test Buttons */
        .quick-tests {
            margin-top: 20px;
            padding: 20px;
            background: #e8f4fd;
            border-radius: 6px;
        }
        .quick-tests h4 {
            margin-top: 0;
            color: #1565c0;
        }
        .test-category {
            margin-bottom: 15px;
        }
        .test-category h5 {
            margin: 10px 0 5px 0;
            color: #333;
        }
        .test-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        .test-btn {
            background: #fff;
            color: #1565c0;
            border: 1px solid #1565c0;
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .test-btn:hover {
            background: #1565c0;
            color: white;
        }
        
        /* Results Styles */
        .results {
            margin-top: 20px;
        }
        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .results-info {
            display: flex;
            gap: 20px;
            font-size: 14px;
        }
        .info-item {
            padding: 4px 12px;
            background: #e3f2fd;
            border-radius: 20px;
            color: #1565c0;
        }
        
        /* Search Results */
        .search-result {
            border: 1px solid #e0e0e0;
            padding: 20px;
            margin-bottom: 15px;
            border-radius: 6px;
            background: white;
        }
        .result-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 15px;
        }
        .episode-title {
            font-size: 18px;
            font-weight: bold;
            color: #333;
        }
        .relevance-score {
            background: #e3f2fd;
            color: #1565c0;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
        }
        .excerpt {
            font-size: 16px;
            line-height: 1.6;
            color: #555;
            margin-bottom: 15px;
        }
        .metadata {
            display: flex;
            gap: 20px;
            font-size: 14px;
            color: #666;
        }
        
        /* Entity Results */
        .entity-card {
            border: 1px solid #e0e0e0;
            padding: 20px;
            margin-bottom: 15px;
            border-radius: 6px;
            background: white;
        }
        .entity-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 15px;
        }
        .entity-name {
            font-size: 20px;
            font-weight: bold;
            color: #333;
        }
        .entity-type {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
            margin-left: 10px;
        }
        .type-PERSON { background: #e3f2fd; color: #1565c0; }
        .type-ORG { background: #f3e5f5; color: #6a1b9a; }
        .type-GPE { background: #e8f5e9; color: #2e7d32; }
        .type-MONEY { background: #fff3e0; color: #e65100; }
        
        /* Stats Section */
        .stats-dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .stat-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
        }
        .stat-value {
            font-size: 32px;
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
        }
        .stat-label {
            font-size: 14px;
            color: #666;
            text-transform: uppercase;
        }
        
        /* Loading and Error States */
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #007bff;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .error {
            background: #fee;
            color: #c00;
            padding: 15px;
            border-radius: 4px;
            margin-top: 20px;
        }
        
        /* Edge Case Testing Section */
        .edge-tests {
            margin-top: 30px;
            padding: 20px;
            background: #fff3cd;
            border-radius: 6px;
            border: 1px solid #ffeaa7;
        }
        .edge-tests h4 {
            margin-top: 0;
            color: #856404;
        }
    </style>
</head>
<body class="console-open">
    <div class="container">
        <!-- Tab Navigation -->
        <div class="tab-nav">
            <button class="tab-button active" onclick="switchTab('search')">üîç Transcript Search</button>
            <button class="tab-button" onclick="switchTab('entities')">üë• Entity Search</button>
            <button class="tab-button" onclick="switchTab('diagnostics')">üîß Diagnostics</button>
        </div>
        
        <!-- Search Tab Content -->
        <div id="search-tab" class="tab-content active">
            <h1>Advanced Transcript Search Testing</h1>
            <p class="subtitle">Test semantic search with comprehensive logging and edge cases</p>
            
            <div class="search-section">
                <h3>üîç Search Configuration</h3>
                <div class="search-controls">
                    <input type="text" id="searchQuery" placeholder="Enter search query..." value="">
                    <input type="number" id="searchLimit" placeholder="Limit" value="5" min="1" max="50" style="width: 100px;">
                    <button onclick="performSearch()">Search</button>
                    <button onclick="clearSearch()" style="background: #6c757d;">Clear</button>
                </div>
                
                <div class="quick-tests">
                    <h4>Quick Test Scenarios</h4>
                    
                    <div class="test-category">
                        <h5>ü§ñ AI/ML Topics</h5>
                        <div class="test-buttons">
                            <button class="test-btn" onclick="runQuickTest('AI startup valuations', 5)">AI valuations</button>
                            <button class="test-btn" onclick="runQuickTest('machine learning business models', 5)">ML business models</button>
                            <button class="test-btn" onclick="runQuickTest('LLM moat defensibility', 5)">LLM moats</button>
                            <button class="test-btn" onclick="runQuickTest('GPT-4 competitive advantage', 5)">GPT-4 advantage</button>
                            <button class="test-btn" onclick="runQuickTest('AI infrastructure costs', 5)">AI costs</button>
                        </div>
                    </div>
                    
                    <div class="test-category">
                        <h5>üí∞ Investment & Funding</h5>
                        <div class="test-buttons">
                            <button class="test-btn" onclick="runQuickTest('Series A metrics benchmarks', 5)">Series A metrics</button>
                            <button class="test-btn" onclick="runQuickTest('down round negotiations', 5)">Down rounds</button>
                            <button class="test-btn" onclick="runQuickTest('venture debt vs equity', 5)">Debt vs Equity</button>
                            <button class="test-btn" onclick="runQuickTest('pre-money post-money valuation', 5)">Valuations</button>
                            <button class="test-btn" onclick="runQuickTest('SAFE notes YC terms', 5)">SAFE notes</button>
                        </div>
                    </div>
                    
                    <div class="test-category">
                        <h5>üöÄ Startup Strategy</h5>
                        <div class="test-buttons">
                            <button class="test-btn" onclick="runQuickTest('product market fit indicators', 5)">PMF indicators</button>
                            <button class="test-btn" onclick="runQuickTest('when to pivot startup', 5)">Pivot timing</button>
                            <button class="test-btn" onclick="runQuickTest('founder burnout mental health', 5)">Founder burnout</button>
                            <button class="test-btn" onclick="runQuickTest('hiring first 10 employees', 5)">Early hiring</button>
                            <button class="test-btn" onclick="runQuickTest('startup growth hacking', 5)">Growth hacking</button>
                        </div>
                    </div>
                    
                    <div class="test-category">
                        <h5>üîó Crypto & Web3</h5>
                        <div class="test-buttons">
                            <button class="test-btn" onclick="runQuickTest('DeFi protocol economics', 5)">DeFi economics</button>
                            <button class="test-btn" onclick="runQuickTest('NFT marketplace dynamics', 5)">NFT markets</button>
                            <button class="test-btn" onclick="runQuickTest('crypto bear market strategies', 5)">Bear market</button>
                            <button class="test-btn" onclick="runQuickTest('blockchain scalability solutions', 5)">Scalability</button>
                            <button class="test-btn" onclick="runQuickTest('Web3 infrastructure plays', 5)">Web3 infra</button>
                        </div>
                    </div>
                    
                    <div class="test-category">
                        <h5>üß™ Edge Cases & Special Characters</h5>
                        <div class="test-buttons">
                            <button class="test-btn" onclick="runQuickTest('', 5)">Empty query</button>
                            <button class="test-btn" onclick="runQuickTest('a', 5)">Single char</button>
                            <button class="test-btn" onclick="runQuickTest('ü¶Ñ unicorn startups', 5)">Emoji query</button>
                            <button class="test-btn" onclick="runQuickTest('Âàõ‰∏öÂÖ¨Âè∏ startup', 5)">Unicode/Chinese</button>
                            <button class="test-btn" onclick="runQuickTest(generateLongText(), 5)">2000+ chars</button>
                            <button class="test-btn" onclick="runQuickTest('!@#$%^&*()', 5)">Special chars</button>
                        </div>
                    </div>
                </div>
            </div>

            <div id="searchResults" class="results"></div>
        </div>
        
        <!-- Entities Tab Content -->
        <div id="entities-tab" class="tab-content">
            <h1>Advanced Entity Search Testing</h1>
            <p class="subtitle">Test entity extraction and tracking with comprehensive filters</p>
            
            <div class="search-section">
                <h3>üîç Entity Search Configuration</h3>
                <div class="search-controls">
                    <input type="text" id="entitySearch" placeholder="Search for entity..." value="">
                    <select id="entityType">
                        <option value="">All Types</option>
                        <option value="PERSON">People</option>
                        <option value="ORG">Organizations</option>
                        <option value="GPE">Places</option>
                        <option value="MONEY">Money/Values</option>
                    </select>
                    <select id="timeframe">
                        <option value="">All Time</option>
                        <option value="30d">Last 30 Days</option>
                        <option value="60d">Last 60 Days</option>
                        <option value="90d">Last 90 Days</option>
                    </select>
                    <input type="number" id="entityLimit" placeholder="Limit" value="10" min="1" max="100" style="width: 100px;">
                    <button onclick="searchEntities()">Search</button>
                    <button onclick="clearEntitySearch()" style="background: #6c757d;">Clear</button>
                </div>
                
                <div class="quick-tests">
                    <h4>Quick Entity Tests</h4>
                    
                    <div class="test-category">
                        <h5>üè¢ Companies</h5>
                        <div class="test-buttons">
                            <button class="test-btn" onclick="runEntityTest('OpenAI', 'ORG')">OpenAI</button>
                            <button class="test-btn" onclick="runEntityTest('Anthropic', 'ORG')">Anthropic</button>
                            <button class="test-btn" onclick="runEntityTest('Google', 'ORG')">Google</button>
                            <button class="test-btn" onclick="runEntityTest('Microsoft', 'ORG')">Microsoft</button>
                            <button class="test-btn" onclick="runEntityTest('Y Combinator', 'ORG')">Y Combinator</button>
                        </div>
                    </div>
                    
                    <div class="test-category">
                        <h5>üë§ People</h5>
                        <div class="test-buttons">
                            <button class="test-btn" onclick="runEntityTest('Sam Altman', 'PERSON')">Sam Altman</button>
                            <button class="test-btn" onclick="runEntityTest('Elon Musk', 'PERSON')">Elon Musk</button>
                            <button class="test-btn" onclick="runEntityTest('Marc Andreessen', 'PERSON')">Marc Andreessen</button>
                            <button class="test-btn" onclick="runEntityTest('Paul Graham', 'PERSON')">Paul Graham</button>
                            <button class="test-btn" onclick="runEntityTest('', 'PERSON', 10)">Top 10 People</button>
                        </div>
                    </div>
                    
                    <div class="test-category">
                        <h5>üìç Locations</h5>
                        <div class="test-buttons">
                            <button class="test-btn" onclick="runEntityTest('San Francisco', 'GPE')">San Francisco</button>
                            <button class="test-btn" onclick="runEntityTest('Silicon Valley', 'GPE')">Silicon Valley</button>
                            <button class="test-btn" onclick="runEntityTest('New York', 'GPE')">New York</button>
                            <button class="test-btn" onclick="runEntityTest('', 'GPE', 10)">Top 10 Places</button>
                        </div>
                    </div>
                    
                    <div class="test-category">
                        <h5>üíµ Money & Valuations</h5>
                        <div class="test-buttons">
                            <button class="test-btn" onclick="runEntityTest('', 'MONEY', 20)">Top 20 Amounts</button>
                            <button class="test-btn" onclick="runEntityTest('billion', 'MONEY')">Billion+ amounts</button>
                            <button class="test-btn" onclick="runEntityTest('million', 'MONEY')">Million+ amounts</button>
                        </div>
                    </div>
                </div>
            </div>

            <div id="entityResults" class="results"></div>
        </div>
        
        <!-- Diagnostics Tab -->
        <div id="diagnostics-tab" class="tab-content">
            <h1>System Diagnostics & Health</h1>
            <p class="subtitle">Monitor API health, performance metrics, and system status</p>
            
            <div class="stats-dashboard" id="statsContainer">
                <div class="stat-card">
                    <div class="stat-value" id="totalRequests">0</div>
                    <div class="stat-label">Total Requests</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="avgResponseTime">0ms</div>
                    <div class="stat-label">Avg Response Time</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="successRate">0%</div>
                    <div class="stat-label">Success Rate</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="lastError">None</div>
                    <div class="stat-label">Last Error</div>
                </div>
            </div>
            
            <div class="search-section">
                <h3>üè• Health Checks</h3>
                <div class="test-buttons">
                    <button class="test-btn" onclick="checkAPIHealth()">Check API Health</button>
                    <button class="test-btn" onclick="checkModalHealth()">Check Modal Health</button>
                    <button class="test-btn" onclick="runStressTest(10)">Stress Test (10 req)</button>
                    <button class="test-btn" onclick="runStressTest(20)">Stress Test (20 req)</button>
                    <button class="test-btn" onclick="testTimeout()">Test Timeout (1s)</button>
                </div>
            </div>
            
            <div id="diagnosticsResults" class="results"></div>
        </div>
    </div>

    <!-- Console/Log Section -->
    <div class="console-section" id="console">
        <div class="console-header">
            <div class="console-title">üìä Debug Console</div>
            <div class="console-actions">
                <button class="console-btn" onclick="clearConsole()">Clear</button>
                <button class="console-btn" onclick="downloadLogs()">Download</button>
                <button class="console-btn" onclick="toggleConsole()">Hide</button>
            </div>
        </div>
        <div id="consoleContent"></div>
    </div>

    <script>
        // Configuration
        const API_BASE = 'https://podinsight-api.vercel.app';
        const MODAL_ENDPOINT = 'https://podinsighthq--podinsight-embeddings-simple-generate-embedding.modal.run';
        
        // State management
        let requestStats = {
            total: 0,
            successful: 0,
            failed: 0,
            responseTimes: [],
            lastError: null
        };
        
        // Auto-save logs
        let allLogs = [];
        let sessionId = new Date().toISOString().replace(/[:.]/g, '-');
        
        // Console logging with auto-save
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const fullTimestamp = new Date().toISOString();
            const consoleContent = document.getElementById('consoleContent');
            
            const logEntry = document.createElement('div');
            logEntry.className = 'log-entry';
            logEntry.innerHTML = `
                <span class="log-time">${timestamp}</span>
                <span class="log-type ${type}">${type.toUpperCase()}</span>
                <span>${message}</span>
            `;
            
            consoleContent.appendChild(logEntry);
            consoleContent.scrollTop = consoleContent.scrollHeight;
            
            // Store log entry
            const logData = {
                timestamp: fullTimestamp,
                type: type,
                message: message
            };
            allLogs.push(logData);
            
            // Also log to browser console
            console.log(`[${type.toUpperCase()}] ${message}`);
            
            // Auto-save logs to localStorage
            saveLogsToStorage();
        }
        
        function saveLogsToStorage() {
            try {
                localStorage.setItem(`podinsight-logs-${sessionId}`, JSON.stringify({
                    sessionId: sessionId,
                    startTime: allLogs[0]?.timestamp || new Date().toISOString(),
                    lastUpdate: new Date().toISOString(),
                    stats: requestStats,
                    logs: allLogs
                }));
            } catch (e) {
                console.error('Failed to save logs to localStorage:', e);
            }
        }
        
        function clearConsole() {
            document.getElementById('consoleContent').innerHTML = '';
            log('Console cleared', 'info');
        }
        
        function toggleConsole() {
            const consoleEl = document.getElementById('console');
            if (consoleEl.style.display === 'none') {
                consoleEl.style.display = 'block';
                document.body.classList.add('console-open');
            } else {
                consoleEl.style.display = 'none';
                document.body.classList.remove('console-open');
            }
        }
        
        function downloadLogs() {
            // Create comprehensive log report
            const report = {
                sessionId: sessionId,
                testDate: new Date().toISOString(),
                duration: allLogs.length > 0 ? 
                    new Date() - new Date(allLogs[0].timestamp) : 0,
                summary: {
                    totalRequests: requestStats.total,
                    successful: requestStats.successful,
                    failed: requestStats.failed,
                    successRate: requestStats.total > 0 ? 
                        ((requestStats.successful / requestStats.total) * 100).toFixed(2) + '%' : '0%',
                    averageResponseTime: requestStats.responseTimes.length > 0 ?
                        (requestStats.responseTimes.reduce((a, b) => a + b, 0) / requestStats.responseTimes.length).toFixed(2) + 'ms' : 'N/A',
                    lastError: requestStats.lastError || 'None'
                },
                responseTimes: requestStats.responseTimes,
                logs: allLogs,
                rawConsoleText: document.getElementById('consoleContent').innerText
            };
            
            // Create formatted text version
            let textReport = `PodInsight Test Report
====================================
Session ID: ${report.sessionId}
Test Date: ${new Date().toLocaleString()}
Duration: ${(report.duration / 1000).toFixed(2)} seconds

SUMMARY
-------
Total Requests: ${report.summary.totalRequests}
Successful: ${report.summary.successful}
Failed: ${report.summary.failed}
Success Rate: ${report.summary.successRate}
Average Response Time: ${report.summary.averageResponseTime}
Last Error: ${report.summary.lastError}

DETAILED LOGS
-------------
${allLogs.map(log => `[${new Date(log.timestamp).toLocaleTimeString()}] [${log.type.toUpperCase()}] ${log.message}`).join('\n')}

RAW CONSOLE OUTPUT
------------------
${report.rawConsoleText}
`;
            
            // Save both JSON and text versions
            const jsonBlob = new Blob([JSON.stringify(report, null, 2)], { type: 'application/json' });
            const textBlob = new Blob([textReport], { type: 'text/plain' });
            
            // Download JSON
            const jsonUrl = window.URL.createObjectURL(jsonBlob);
            const jsonLink = document.createElement('a');
            jsonLink.href = jsonUrl;
            jsonLink.download = `podinsight-test-report-${sessionId}.json`;
            jsonLink.click();
            window.URL.revokeObjectURL(jsonUrl);
            
            // Download text
            setTimeout(() => {
                const textUrl = window.URL.createObjectURL(textBlob);
                const textLink = document.createElement('a');
                textLink.href = textUrl;
                textLink.download = `podinsight-test-report-${sessionId}.txt`;
                textLink.click();
                window.URL.revokeObjectURL(textUrl);
            }, 100);
            
            log('Test report downloaded (JSON + TXT formats)', 'success');
        }
        
        // Tab switching
        function switchTab(tabName) {
            log(`Switching to ${tabName} tab`, 'info');
            
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            document.querySelectorAll('.tab-button').forEach(button => {
                button.classList.remove('active');
            });
            
            document.getElementById(tabName + '-tab').classList.add('active');
            event.target.classList.add('active');
        }
        
        // Helper functions
        function generateLongText() {
            return 'venture capital funding ' + 'startup ecosystem innovation '.repeat(100);
        }
        
        function updateStats() {
            document.getElementById('totalRequests').textContent = requestStats.total;
            document.getElementById('successRate').textContent = 
                requestStats.total > 0 ? 
                Math.round((requestStats.successful / requestStats.total) * 100) + '%' : '0%';
            
            if (requestStats.responseTimes.length > 0) {
                const avgTime = requestStats.responseTimes.reduce((a, b) => a + b, 0) / requestStats.responseTimes.length;
                document.getElementById('avgResponseTime').textContent = Math.round(avgTime) + 'ms';
            }
            
            document.getElementById('lastError').textContent = requestStats.lastError || 'None';
        }
        
        // Search functionality
        function runQuickTest(query, limit = 5) {
            log(`Running quick test: "${query}" (limit: ${limit})`, 'info');
            document.getElementById('searchQuery').value = query;
            document.getElementById('searchLimit').value = limit;
            performSearch();
        }
        
        async function performSearch() {
            const query = document.getElementById('searchQuery').value;
            const limit = document.getElementById('searchLimit').value || 5;
            
            log(`Performing search: query="${query}", limit=${limit}`, 'info');
            
            if (!query && query !== '') {
                log('Search cancelled: No query provided', 'warning');
                alert('Please enter a search query');
                return;
            }
            
            const resultsDiv = document.getElementById('searchResults');
            resultsDiv.innerHTML = '<div class="loading"><div class="spinner"></div>Searching transcripts...</div>';
            
            const startTime = performance.now();
            requestStats.total++;
            
            try {
                log(`Sending POST request to ${API_BASE}/api/search`, 'debug');
                
                const response = await fetch(`${API_BASE}/api/search`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        query: query,
                        limit: parseInt(limit),
                        offset: 0
                    })
                });
                
                const endTime = performance.now();
                const responseTime = Math.round(endTime - startTime);
                requestStats.responseTimes.push(responseTime);
                
                log(`Response received: status=${response.status}, time=${responseTime}ms`, 
                    response.ok ? 'success' : 'error');
                
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.detail || `HTTP ${response.status}: Search failed`);
                }
                
                requestStats.successful++;
                log(`Search successful: ${data.total_results} results found`, 'success');
                displaySearchResults(data, responseTime);
                
            } catch (error) {
                requestStats.failed++;
                requestStats.lastError = error.message;
                log(`Search failed: ${error.message}`, 'error');
                resultsDiv.innerHTML = `<div class="error">Error: ${error.message}</div>`;
            }
            
            updateStats();
        }
        
        function displaySearchResults(data, responseTime) {
            const resultsDiv = document.getElementById('searchResults');
            
            if (!data.results || data.results.length === 0) {
                resultsDiv.innerHTML = '<div class="error">No results found</div>';
                log('No results found for query', 'warning');
                return;
            }
            
            let html = `
                <div class="results-header">
                    <h3>Search Results</h3>
                    <div class="results-info">
                        <span class="info-item">Total: ${data.total_results}</span>
                        <span class="info-item">Showing: ${data.results.length}</span>
                        <span class="info-item">Time: ${responseTime}ms</span>
                    </div>
                </div>
            `;
            
            html += data.results.map((result, index) => {
                log(`Result ${index + 1}: ${result.episode_title} (${Math.round(result.similarity_score * 100)}% relevant)`, 'debug');
                
                return `
                    <div class="search-result">
                        <div class="result-header">
                            <div class="episode-title">${result.episode_title || 'Unknown Episode'}</div>
                            <div class="relevance-score">${Math.round(result.similarity_score * 100)}% relevant</div>
                        </div>
                        
                        <div class="excerpt">${result.excerpt}</div>
                        
                        <div class="metadata">
                            <span><strong>Published:</strong> ${result.published_at ? new Date(result.published_at).toLocaleDateString() : 'Unknown'}</span>
                            <span><strong>Episode ID:</strong> ${result.episode_id || 'N/A'}</span>
                            <span><strong>Chunk ID:</strong> ${result.chunk_id || 'N/A'}</span>
                        </div>
                    </div>
                `;
            }).join('');
            
            resultsDiv.innerHTML = html;
        }
        
        function clearSearch() {
            document.getElementById('searchQuery').value = '';
            document.getElementById('searchResults').innerHTML = '';
            log('Search cleared', 'info');
        }
        
        // Entity search functionality
        function runEntityTest(search, type, limit = 10) {
            log(`Running entity test: search="${search}", type=${type}, limit=${limit}`, 'info');
            document.getElementById('entitySearch').value = search;
            document.getElementById('entityType').value = type || '';
            document.getElementById('entityLimit').value = limit;
            searchEntities();
        }
        
        async function searchEntities() {
            const search = document.getElementById('entitySearch').value;
            const type = document.getElementById('entityType').value;
            const timeframe = document.getElementById('timeframe').value;
            const limit = document.getElementById('entityLimit').value || 10;
            
            log(`Searching entities: search="${search}", type=${type}, timeframe=${timeframe}, limit=${limit}`, 'info');
            
            const resultsDiv = document.getElementById('entityResults');
            resultsDiv.innerHTML = '<div class="loading"><div class="spinner"></div>Searching entities...</div>';
            
            const startTime = performance.now();
            requestStats.total++;
            
            try {
                const params = new URLSearchParams();
                if (search) params.append('search', search);
                if (type) params.append('type', type);
                if (timeframe) params.append('timeframe', timeframe);
                params.append('limit', limit);
                
                const url = `${API_BASE}/api/entities?${params}`;
                log(`Sending GET request to ${url}`, 'debug');
                
                const response = await fetch(url);
                const endTime = performance.now();
                const responseTime = Math.round(endTime - startTime);
                requestStats.responseTimes.push(responseTime);
                
                log(`Response received: status=${response.status}, time=${responseTime}ms`, 
                    response.ok ? 'success' : 'error');
                
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.detail || `HTTP ${response.status}: Entity search failed`);
                }
                
                requestStats.successful++;
                log(`Entity search successful: ${data.total_entities} entities found`, 'success');
                displayEntityResults(data, responseTime);
                
            } catch (error) {
                requestStats.failed++;
                requestStats.lastError = error.message;
                log(`Entity search failed: ${error.message}`, 'error');
                resultsDiv.innerHTML = `<div class="error">Error: ${error.message}</div>`;
            }
            
            updateStats();
        }
        
        function displayEntityResults(data, responseTime) {
            const resultsDiv = document.getElementById('entityResults');
            
            if (!data.entities || data.entities.length === 0) {
                resultsDiv.innerHTML = '<div class="error">No entities found</div>';
                log('No entities found', 'warning');
                return;
            }
            
            let html = `
                <div class="results-header">
                    <h3>Entity Results</h3>
                    <div class="results-info">
                        <span class="info-item">Total: ${data.total_entities}</span>
                        <span class="info-item">Showing: ${data.entities.length}</span>
                        <span class="info-item">Time: ${responseTime}ms</span>
                    </div>
                </div>
            `;
            
            html += data.entities.map((entity, index) => {
                log(`Entity ${index + 1}: ${entity.name} (${entity.type}) - ${entity.mention_count} mentions`, 'debug');
                
                return `
                    <div class="entity-card">
                        <div class="entity-header">
                            <div>
                                <span class="entity-name">${entity.name}</span>
                                <span class="entity-type type-${entity.type}">${entity.type}</span>
                            </div>
                            <span class="trend trend-${entity.trend}">
                                ${entity.trend === 'up' ? '‚Üë' : entity.trend === 'down' ? '‚Üì' : '‚Üí'} 
                                ${entity.trend}
                            </span>
                        </div>
                        
                        <div class="entity-stats">
                            <div class="stat">
                                <div class="stat-value">${entity.mention_count}</div>
                                <div class="stat-label">Total Mentions</div>
                            </div>
                            <div class="stat">
                                <div class="stat-value">${entity.episode_count}</div>
                                <div class="stat-label">Episodes</div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            resultsDiv.innerHTML = html;
        }
        
        function clearEntitySearch() {
            document.getElementById('entitySearch').value = '';
            document.getElementById('entityType').value = '';
            document.getElementById('entityResults').innerHTML = '';
            log('Entity search cleared', 'info');
        }
        
        // Diagnostics functionality
        async function checkAPIHealth() {
            log('Checking API health...', 'info');
            const resultsDiv = document.getElementById('diagnosticsResults');
            
            try {
                const response = await fetch(`${API_BASE}/api/health`);
                const data = await response.json();
                
                if (response.ok) {
                    log('API health check passed', 'success');
                    resultsDiv.innerHTML = `
                        <div class="search-result">
                            <h4>‚úÖ API Health Check Passed</h4>
                            <pre>${JSON.stringify(data, null, 2)}</pre>
                        </div>
                    `;
                } else {
                    throw new Error('Health check failed');
                }
            } catch (error) {
                log(`API health check failed: ${error.message}`, 'error');
                resultsDiv.innerHTML = `<div class="error">API Health Check Failed: ${error.message}</div>`;
            }
        }
        
        async function checkModalHealth() {
            log('Checking Modal endpoint health...', 'info');
            const resultsDiv = document.getElementById('diagnosticsResults');
            
            try {
                const response = await fetch(`${MODAL_ENDPOINT.replace('generate-embedding', 'health-check')}`);
                const data = await response.json();
                
                if (response.ok) {
                    log('Modal health check passed', 'success');
                    resultsDiv.innerHTML = `
                        <div class="search-result">
                            <h4>‚úÖ Modal Health Check Passed</h4>
                            <pre>${JSON.stringify(data, null, 2)}</pre>
                        </div>
                    `;
                } else {
                    throw new Error('Modal health check failed');
                }
            } catch (error) {
                log(`Modal health check failed: ${error.message}`, 'error');
                resultsDiv.innerHTML = `<div class="error">Modal Health Check Failed: ${error.message}</div>`;
            }
        }
        
        async function runStressTest(count) {
            log(`Starting stress test with ${count} concurrent requests...`, 'warning');
            const resultsDiv = document.getElementById('diagnosticsResults');
            resultsDiv.innerHTML = '<div class="loading"><div class="spinner"></div>Running stress test...</div>';
            
            const promises = [];
            const startTime = performance.now();
            
            for (let i = 0; i < count; i++) {
                promises.push(
                    fetch(`${API_BASE}/api/search`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            query: `stress test query ${i}`,
                            limit: 1
                        })
                    })
                );
            }
            
            try {
                const results = await Promise.allSettled(promises);
                const endTime = performance.now();
                const totalTime = Math.round(endTime - startTime);
                
                const successful = results.filter(r => r.status === 'fulfilled' && r.value.ok).length;
                const failed = count - successful;
                
                log(`Stress test complete: ${successful}/${count} successful in ${totalTime}ms`, 
                    failed > 0 ? 'warning' : 'success');
                
                resultsDiv.innerHTML = `
                    <div class="search-result">
                        <h4>Stress Test Results</h4>
                        <p>Total requests: ${count}</p>
                        <p>Successful: ${successful}</p>
                        <p>Failed: ${failed}</p>
                        <p>Total time: ${totalTime}ms</p>
                        <p>Avg time per request: ${Math.round(totalTime / count)}ms</p>
                    </div>
                `;
            } catch (error) {
                log(`Stress test failed: ${error.message}`, 'error');
                resultsDiv.innerHTML = `<div class="error">Stress test failed: ${error.message}</div>`;
            }
        }
        
        async function testTimeout() {
            log('Testing timeout behavior (1s limit)...', 'info');
            const resultsDiv = document.getElementById('diagnosticsResults');
            
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 1000);
            
            try {
                const startTime = performance.now();
                const response = await fetch(`${MODAL_ENDPOINT}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ text: 'timeout test' }),
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);
                const endTime = performance.now();
                
                log(`Request completed in ${Math.round(endTime - startTime)}ms`, 'success');
                resultsDiv.innerHTML = `
                    <div class="search-result">
                        <h4>‚úÖ Request completed before timeout</h4>
                        <p>Response time: ${Math.round(endTime - startTime)}ms</p>
                    </div>
                `;
            } catch (error) {
                if (error.name === 'AbortError') {
                    log('Request timed out after 1s (expected behavior)', 'success');
                    resultsDiv.innerHTML = `
                        <div class="search-result">
                            <h4>‚úÖ Timeout Test Passed</h4>
                            <p>Request properly timed out after 1 second</p>
                        </div>
                    `;
                } else {
                    log(`Timeout test error: ${error.message}`, 'error');
                    resultsDiv.innerHTML = `<div class="error">Timeout test error: ${error.message}</div>`;
                }
            }
        }
        
        // Session recovery functions
        function loadPreviousSessions() {
            const sessions = [];
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key.startsWith('podinsight-logs-')) {
                    try {
                        const data = JSON.parse(localStorage.getItem(key));
                        sessions.push(data);
                    } catch (e) {
                        console.error('Failed to load session:', key, e);
                    }
                }
            }
            return sessions.sort((a, b) => new Date(b.lastUpdate) - new Date(a.lastUpdate));
        }
        
        function showSessionHistory() {
            const sessions = loadPreviousSessions();
            if (sessions.length === 0) {
                log('No previous test sessions found', 'info');
                return;
            }
            
            log(`Found ${sessions.length} previous test sessions:`, 'info');
            sessions.slice(0, 5).forEach((session, index) => {
                const duration = new Date(session.lastUpdate) - new Date(session.startTime);
                log(`Session ${index + 1}: ${new Date(session.startTime).toLocaleString()} - ${session.logs.length} logs, ${session.stats.total} requests`, 'debug');
            });
        }
        
        // Auto-save test results on page unload
        window.addEventListener('beforeunload', () => {
            if (allLogs.length > 0) {
                saveLogsToStorage();
                // Also save to sessionStorage for recovery
                sessionStorage.setItem('podinsight-last-session', sessionId);
            }
        });
        
        // Initialize on load
        window.onload = () => {
            log('PodInsight Advanced Testing Suite initialized', 'success');
            log(`Session ID: ${sessionId}`, 'info');
            log(`API endpoint: ${API_BASE}`, 'info');
            log(`Modal endpoint: ${MODAL_ENDPOINT}`, 'info');
            
            // Show session history
            showSessionHistory();
            
            // Add auto-save indicator
            const consoleHeader = document.querySelector('.console-header');
            const autoSaveIndicator = document.createElement('span');
            autoSaveIndicator.style.color = '#4ade80';
            autoSaveIndicator.style.fontSize = '12px';
            autoSaveIndicator.style.marginLeft = '10px';
            autoSaveIndicator.innerHTML = '‚úì Auto-saving enabled';
            consoleHeader.querySelector('.console-title').appendChild(autoSaveIndicator);
            
            updateStats();
            
            // Log keyboard shortcuts
            log('Keyboard shortcuts: Ctrl+Enter to search, Ctrl+L to clear console, Ctrl+S to download logs', 'info');
        };
        
        // Add keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            // Ctrl+Enter to search
            if (e.ctrlKey && e.key === 'Enter') {
                const activeTab = document.querySelector('.tab-content.active').id;
                if (activeTab === 'search-tab') {
                    performSearch();
                } else if (activeTab === 'entities-tab') {
                    searchEntities();
                }
            }
            
            // Ctrl+L to clear console
            if (e.ctrlKey && e.key === 'l') {
                e.preventDefault();
                clearConsole();
            }
            
            // Ctrl+S to save logs
            if (e.ctrlKey && e.key === 's') {
                e.preventDefault();
                downloadLogs();
            }
        });
    </script>
</body>
</html>